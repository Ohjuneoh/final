<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.helf.mapper.UserMapper">
	
	<select id="getUserById" parameterType="string" resultType="User">
		select
			user_id					as id,
			user_email				as email,
			user_name				as name,
			user_tel				as tel,
			user_encrypted_password as encryptedPassword,
			user_gender				as gender,
			user_status				as status,
			user_mobile_carrier		as mobileCarrier,
			user_create_date		as createDate,
			user_update_date		as updateDate,
			user_point				as point,
			rank_no					as "rank.no",
			user_type				as type
			
		from
			helf_users
		where 
			user_id = #{value}
	</select>
	
	<!-- 유저정보 업데이트(수정)  -->
	<update id="updateUser" parameterType="User">
		update 
			helf_users
		set 
			user_email  = 	#{email},			
			user_name   = 	#{name},			
			user_tel    = 	#{tel},	
			user_encrypted_password = #{encryptedPassword},
			user_gender	=	#{gender},		
			user_status	=	#{status},	
			user_update_date = sysdate,
			user_type	= #{type},
			user_point 	= #{point},
			user_mobile_carrier = #{mobileCarrier},
			user_authentication_no = #{authenticationNo}
		where 
			user_id = #{id}
	</update>

	<insert id="insertUser" parameterType="User">
		insert into helf_users
		(user_id, user_email, user_name, user_tel, user_encrypted_password,
		 user_gender, user_type, rank_no, user_point, user_mobile_carrier)
		values
		(#{id}, #{email}, #{name}, #{tel}, #{encryptedPassword}, 
		 #{gender}, #{type}, #{rank.no}, #{point}, #{mobileCarrier})
	</insert>
	
	<!-- 트레이너 회원가입 1단계 (유저객체에 등록) -->
	<insert id="insertTrainer" parameterType="User">
		insert into helf_users
		(user_id, user_email, user_name, user_tel, user_encrypted_password,
		 user_gender, user_status, user_type, rank_no, user_point, user_mobile_carrier)
		values
		(#{id}, #{email}, #{name}, #{tel}, #{encryptedPassword}, 
		 #{gender}, #{status}, #{type}, null, #{point}, #{mobileCarrier})
	</insert>
	
	<!-- 트레이너 회원가입 2단계 (트레이너객체에 등록) -->
	<insert id="insertTrainer2" parameterType="Trainer">
		<selectKey keyProperty="trainerNo" resultType="int" order="BEFORE">
			select helf_files_seq.nextval from dual
		</selectKey>
		insert into helf_trainers
		(trainer_no, trainer_file, user_id)
		values
		(#{trainerNo}, #{trainerFile}, #{user.id})
	</insert>

	<!-- 트레이너 회원가입 2단계 (트레이너 경력객체에 등록) -->
	<insert id="insertTrainerCareer" parameterType="TrainerCareer">
		insert into helf_trainer_career
		(career_no, career_name, career_start_date, career_end_date, trainer_no)
		values
		(helf_trainer_career_seq.nextval, #{name}, #{startDate}, #{endDate}, #{trainer.trainerNo})
	</insert>
	
	<select id="getUsersByDigits" parameterType="string" resultType="kr.co.helf.vo.User">
		select
			user_id					as id,
			user_email				as email,
			user_name				as name,
			user_tel				as tel,
			user_encrypted_password as encryptedPassword,
			user_gender				as gender,
			user_status				as status,
			user_mobile_carrier		as mobileCarrier,
			user_create_date		as createDate,
			user_update_date		as updateDate,
			user_point				as point,
			rank_no					as "rank.no",
			user_type				as type
		from
			helf_users
		where substr(user_tel, 10, 4) = #{value}
	</select>
	
	<!-- 아이디찾기 -->
	<select id="getIdByTel" resultType="string">
		select
			user_id
		from
			helf_users
		where 
			user_name = #{name}
			and user_tel = #{tel}
	</select>
	
	
	<!-- 아이디중복검사  -->
	<select id="idCheck" resultType="int" parameterType="string">
		select count(*) from helf_users where user_id = #{value}
	</select>
	
<<<<<<< Updated upstream
	<!-- 유저정보 업데이트(수정)  -->
	<update id="updateUser" parameterType="User">
		update 
			helf_users
		set 
			user_email  = 	#{email},			
			user_name   = 	#{name},			
			user_tel    = 	#{tel},	
			user_encrypted_password = #{encryptedPassword},
			user_gender	=	#{gender},		
			user_status	=	#{status},	
			user_update_date = sysdate,
			user_type	= #{type},
			user_point 	= #{point},
			user_mobile_carrier = #{mobileCarrier},
			user_authentication_no = #{authenticationNo}
		where 
			user_id = #{id}
	</update>
	
	
	<!-- 유저의 이용가능한 이용권 조회  // 추후 이용권 부분으로 옮길 예정 -->
=======
	<!-- 유저의 이용가능한 이용권 조회  -->
>>>>>>> Stashed changes
	<select id="getMyMembership" resultType="kr.co.helf.vo.MyMembership" parameterType="string">
		select
			A.my_membership_no				as no,
			A.my_membership_startdate		as startDate,
			A.my_membership_enddate			as endDate,
			A.my_membership_remainder_cnt	as remainderCnt,
			A.my_membership_state			as state,
			A.user_id						as "user.id",
			A.membership_no					as "membership.no",
			B.membership_name				as "membership_name",
			C.category_no					as "membership.category.no",
			D.user_type						as "user.type",
			D.user_name						as "user.name"
			
		from
			helf_my_membership A
		Join
			helf_users D on A.user_id = D.user_id
		Join
			helf_membership B on A.membership_no = B.membership_no
		Join
			helf_membership_category C on B.category_no = C.category_no	
		where A.user_id = #{value}
        and A.my_membership_state = 'Y'
        and C.category_no IN (1, 2)
	</select>
	
	<insert id="insertAttendance" parameterType="map">
		insert into helf_customer_attendance
    				(customer_attendance_no, user_id, my_membership_no)
		values 
    				(helf_customer_attendance_seq.nextval, #{userId}, #{myMembershipNo})
	</insert>
	
	<!-- 직원 출퇴근 내역 총 행의 갯수  -->
	<select id="getTrainerTotalRows" parameterType="map" resultType="int">
	select count(*)
	from helf_trainer_attendance
	where
		user_id = #{userId}
		<if test="state != null">
			and trainer_attendance_state = #{state}
		</if>
	</select>
	
	<!-- 직원 출퇴근 내역  - 채경 -->
	<select id="getTrainerAttendances" parameterType="map" resultType="kr.co.helf.vo.TrainerAttendance">
	select *
	from (
		select 
			trainer_attendance_no				as no,
			trainer_attendance_date				as "date",
			user_id								as "user.id",
			trainer_attendance_cause			as cause,
			trainer_attendance_state			as state,
			row_number() over (order by trainer_attendance_no desc) row_number
		from helf_trainer_attendance
		where
			user_id = #{userId}
			<if test="state != null">
				and trainer_attendance_state = #{state}
			</if>
		order by trainer_attendance_no desc
	) 
	where row_number between #{begin} and #{end}
	</select>
	
	<!-- 직원 출퇴근 등록 - 채경 -->
	<insert id="insertTrainerAttendances" parameterType="map">
		insert into helf_trainer_attendance(trainer_attendance_no, user_id, trainer_attendance_state, trainer_attendance_cause)
		values(helf_trainer_attendance_seq.nextval, #{userId}, #{state}, #{cause})	
	</insert>
	
	<select id="getCustomerTotalRows" resultType="int">
		select count(*)
		from helf_users
		where user_type = 'ROLE_USER'	
	</select>
	
	<!-- 고객 정보 조회 내역 - 채경 -->
	<select id="getCustomers" parameterType="map" resultType="kr.co.helf.dto.CustomerListDto" >
		WITH LatestOrder AS (
		    SELECT
		       o.user_id,
		        m.membership_name,
		        o.orders_payment_date,
		        mm.my_membership_remainder_cnt,
		        mm.my_membership_enddate,
		        mm.my_membership_state,
		        ROW_NUMBER() OVER (PARTITION BY o.user_id ORDER BY o.orders_payment_date DESC) AS latest_rn
		    FROM HELF_ORDERS o
		    LEFT JOIN helf_my_membership mm ON o.my_membership_no = mm.my_membership_no
		    LEFT JOIN helf_membership m ON mm.membership_no = m.membership_no
		),
		
			FirstOrder AS (
		    	SELECT
			        o.user_id,
			        o.orders_payment_date,
			        ROW_NUMBER() OVER (PARTITION BY o.user_id ORDER BY o.orders_payment_date ASC) AS first_rn
			    FROM HELF_ORDERS o
			)
		
		, AllData AS (
		    SELECT 
		        u.user_id       as userId,
		        u.user_name     as userName,
		        u.user_gender   as userGender,
		        u.user_tel      as userTel,
		        u.user_status   as userStatus,
		        f.orders_payment_date AS firstOrderDate,
		        l.orders_payment_date AS latestOrderDate,
		        l.membership_name AS MembershipName,
		        l.my_membership_remainder_cnt AS myMembershipRemainderCnt,
		        l.my_membership_enddate AS myMembershipEndDate,
		        l.my_membership_state   AS myMembershipState,
		        ROW_NUMBER() OVER (ORDER BY u.user_name) AS row_number
		    FROM HELF_USERS u
		    LEFT JOIN FirstOrder f ON u.user_id = f.user_id AND f.first_rn = 1
		    LEFT JOIN LatestOrder l ON u.user_id = l.user_id AND l.latest_rn = 1
		    WHERE u.user_type = 'ROLE_USER'
		    <choose>
		        <when test="opt == 'name'">
		            AND u.user_name = INITCAP(#{keyword})
		        </when>
		        <when test="opt == 'tel'">
		            AND u.user_tel = #{keyword}
		        </when>
		        <when test="userStatus == '유효회원'">
		            AND u.user_status = 'Y'
		        </when>
		        <when test="userStatus == '탈퇴회원'">
		            AND u.user_status = 'N' 
		        </when>
		        <when test="membershipState == '유효'">
		            AND l.my_membership_state = 'Y'
		        </when>
		        <when test="membershipState == '만료'">
		            AND l.my_membership_state = 'N'
		        </when>
		        <when test="remainderCnt != null">
		            AND l.my_membership_remainder_cnt = #{remainderCnt}
		        </when>
		        <when test="remainingDays1 != null and remainingDays2 != null">
		            AND l.my_membership_enddate BETWEEN #{remainingDays1} AND #{remainingDays2}
		        </when>
		    </choose>
		)
		SELECT * 
		FROM AllData
		WHERE row_number BETWEEN #{begin} AND #{end}
		ORDER BY row_number
	</select>
	
	<select id="getCustomerInfoDetails" parameterType="String" resultType="kr.co.helf.dto.CustomerDetailDto">
	select 
		u.user_id					as "user.id", 
		u.user_email				as "user.email", 
		u.user_name					as "user.name", 
		u.user_tel					as "user.tel", 
		u.user_gender				as "user.gender", 
		u.user_status				as "user.status", 
		u.user_create_date			as "user.createDate", 
		u.user_point				as "user.point", 
		r.rank_name					as "user.rank.name", 
		rv.recent_visit				as recentVisitDate, 
		ac.accumulated_orders		as accumulatedOrderTotalPrice
	from helf_users u, helf_ranks r, (select max(customer_attendance_Date) recent_visit
									  from helf_customer_attendance
									  where user_id = #{value}) rv,
																		(select sum(orders_total_price) as accumulated_orders
																		from helf_orders
																		where user_id = #{value}) ac
	where u.user_id = #{value}
	and u.rank_no = r.rank_no
	</select>
	
	<select id="getCustomerLessons" parameterType="String" resultType="kr.co.helf.vo.LessonApply">
	select 
			l.lesson_date			as "lesson.date", 
			l.lesson_time			as "lesson.time", 
			l.lesson_name			as "lesson.name", 
			u.user_name				as "lesson.user.name", 
			la.lesson_apply_status	as attendanceStatus,
			m.membership_name		as "myMembership.membership.name"
	from helf_lesson_apply la, helf_lesson l, helf_users u, helf_my_membership mm, helf_membership m
	where la.lesson_no = l.lesson_no
	and l.user_id = u.user_id
	and la.my_membership_no = mm.my_membership_no 
	and mm.membership_no = m.membership_no 
	and la.user_id = #{value}
	</select>

	<select id="getCustomerAttendance" parameterType="String" resultType="kr.co.helf.vo.CustomerAttendance">
	select distinct 
				ca.customer_attendance_no		as no, 
				ca.customer_attendance_date		as "date", 
				mc.category_name				as "myMembership.membership.category.name", 
				m.membership_name				as "myMembership.membership.name", 
				l.lesson_name					as lessonName
	from helf_customer_attendance ca, helf_my_membership mm, helf_membership m, helf_membership_category mc, helf_lesson_apply la, helf_lesson l
	where ca.my_membership_no = mm.my_membership_no 
	and mm.membership_no = m.membership_no
	and m.category_no = mc.category_no 
	and la.my_membership_no(+) = mm.my_membership_no
	and la.lesson_no = l.lesson_no(+)
	and ca.user_id = #{value}
	order by ca.customer_attendance_date desc 	</select>

</mapper>